/* 
 * partify -  A framework for development of Web applications 
 *          partitioned in different communicating devices.
 * http://www.partify.org/
 * Copyright (C) 2014  Simeon Ivaylov Petrov, Alessio Bellino, Flavio De Paoli
 * 
 * This file is part of partify.
 * 
 * partify is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * partify is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/agpl-3.0.html.
*/
(function(e){e.fn.partify=function(t){function x(){T();M();_();D();O();B();k()}function T(){o.connectionTypesArray=["newVc","connVc"];o.componentsArray=Object.keys(o.components);o.devicesArray=Object.keys(o.devices);o.layoutsArray=Object.keys(o.layouts);f={};l={};c={};h={};p=null;d=null;v="monoDevice";m="multiDevice";g=v;y=false;b=5e3;y=false;w=false;E=null;S=null}function N(){if(!e.isEmptyObject(f)){f.close()}C()}function C(){k();W();k();if(y){e("link[href='"+c.css+"']").remove();H();X();V();F(function(){o.onMonoDeviceMode();c.onMonoDeviceMode()})}else{F()}T();o.onDestroy()}function k(){n.html(o.html.connectButton);e(document).off("click",r);e(document).on("click",r,function(){o.onInit();j();I();return false})}function L(){n.html(o.html.disconnectButton);e(document).off("click",r);e(document).on("click",r,function(){N()})}function A(t){N();if(o.debug){e.error("partify => "+t)}}function O(){e.each(o.devices,function(e,t){if(t.minWidth&&t.maxWidth){if(window.screen.width>=t.minWidth&&window.screen.width<=t.maxWidth){u=t;u.screenWidth=window.screen.width;u.screenHeight=window.screen.height}}else{A('The device "'+e+'" must have "minWidh" and "maxWidth" properties');return false}})}function M(){var t={id:"",minWidth:0,maxWidth:0};e.each(o.devices,function(n,r){t.id=n;o.devices[n]=e.extend(true,{},t,r)})}function _(){if(!e.isEmptyObject(o.components)){var t={id:"",selector:"",monoDeviceVisible:true};if(o.stateful){t.state={}}e.each(o.components,function(n,r){t.id=n;t.monoDeviceVisible=!e(r.selector).is(":hidden");o.components[n]=e.extend(true,{},t,r)})}else{A("You must define at least one component");return false}}function D(){var t={};var n={};n.partify={};e.each(i.partify,function(e,t){n.partify[t]=function(){}});var r={id:"",name:"",description:"",connectionTypes:"newVc, connVc",devices:"",components:"",css:"",maxInstances:-1,hidden:false,events:{outgoing:t,incoming:n},onMultiDeviceMode:function(){},onMonoDeviceMode:function(){},onWarning:function(e){},onWsOpen:function(e){},onWsMessage:function(e){},onWsError:function(e){},onWsClose:function(e,t){}};if(!e.isEmptyObject(o.layouts)){e.each(o.layouts,function(t,n){r.id=t;o.layouts[t]=e.extend(true,{},r,n)});e.each(o.layouts,function(t,n){n.connectionTypesArray=e.map(n.connectionTypes.split(","),e.trim);if(e.trim(n.connectionTypesArray)!=""){e.each(n.connectionTypesArray,function(n,r){if(e.inArray(r,o.connectionTypesArray)==-1){A('The connection type "'+r+'" of the layout "'+t+'" does not exist (available connection types: "newVc", "connVc")');return false}})}else{A('You must list at least one connection type for the layout "'+t+'"');return false}n.devicesArray=e.map(n.devices.split(","),e.trim);if(e.trim(n.devices)!=""){e.each(n.devicesArray,function(n,r){if(e.inArray(r,o.devicesArray)==-1){A('The device "'+r+'" of the layout "'+t+'" does not exist (available devices: "'+o.devicesArray.join('", "')+'")');return false}})}else{A('You must list at least one device for the layout "'+t+'"');return false}n.componentsArray=e.map(n.components.split(","),e.trim);if(e.trim(n.componentsArray)!=""){e.each(n.componentsArray,function(n,r){if(e.inArray(r,o.componentsArray)==-1){A('The component "'+r+'" of the layout "'+t+'" does not exist (available components: "'+o.componentsArray.join('", "')+'")');return false}})}else{A('You must list at least one component for the layout "'+t+'"');return false}e.each(n.events.outgoing,function(r,i){n.events.outgoing[r+"Obj"]={};var s={};if(i.match(/(?:[^,(]|\([^)]*\))+/g)!=null){e.each(i.match(/(?:[^,(]|\([^)]*\))+/g),function(e,i){s=R(t,r,i);n.events.outgoing[r+"Obj"][s.event]={};if(o.stateful){n.events.outgoing[r+"Obj"][s.event].affectedComponents=s.affectedComponents}})}else{A('You must list at least one outgoing event of type "'+r+'" for the layout "'+t+'"');return false}})})}else{A("You must define at least one layout");return false}}function P(){e('<link href="'+c.css+'" rel="stylesheet" type="text/css" media="screen">').appendTo("head");e("body").animate({scrollTop:0},"fast");e.each(o.components,function(t,n){if(e.inArray(t,c.componentsArray)>-1){e(n.selector).show()}else{e(n.selector).hide()}})}function H(){e.each(o.components,function(t,n){if(n.monoDeviceVisible){e(n.selector).show()}else{e(n.selector).hide()}})}function B(){var t="";t='<div id="partifyOverlay"></div>';var n="";n+='<div id="partifyWindow">';n+='	<div id="partifyWindowHeader">';n+='	    <div id="partifyWindowTitle">'+o.html.window.header.title+"</div>";n+='	    <div id="partifyWindowClose">'+o.html.window.header.close+"</div>";n+="	</div>";n+='	<div id="partifyWindowContent"></div>';n+='	<img src="'+o.html.window.content.loadingImgPath+'" style="display:none;"/>';n+="</div>";e("body").append(t);e("body").append(n)}function j(){if(e("#partifyWindow").is(":hidden")){e("#partifyWindow").slideDown("fast");e("#partifyOverlay").fadeIn("fast").promise().done(function(){o.onWindowShow();e(document).off("click","#partifyWindowClose, #partifyOverlay");e(document).on("click","#partifyWindowClose, #partifyOverlay",function(){N()})})}}function F(t){if(!e("#partifyOverlay").is(":hidden")){e("#partifyOverlay").fadeOut("fast");e("#partifyWindow").slideUp("fast").promise().done(function(){o.onWindowHide();e("#partifyVcId").html("");e(".partifyWarningMessage").html("");if(t)t()})}else{if(t)t()}}function I(){var t=[];e.each(o.layouts,function(n,r){if(e.inArray(u.id,r.devicesArray)>-1&&!r.hidden){t.push(n)}});var n="";if(t.length>1){n+='<div id="partifyLayoutsCell">';n+='	    <div id="partifyLayoutsBox">';n+='             <div class="partifyLoadingBox">';n+='                 <img src="'+o.html.window.content.loadingImgPath+'" class="partifyLoadingImg"/>';n+="             </div>";n+='             <div id="partifyLayoutChoice">';n+='                 <div id="partifyLayoutLabel">'+o.html.window.content.layoutsLabel+"</div>";n+='                 <div id="partifyLayouts">';e.each(t,function(e,t){var r=o.layouts[t];n+='             <div class="partifyLayout partifyButton" layoutId="'+t+'">';n+='                 <div class="partifyLayoutName">'+r.html.name+"</div>";n+='                 <div class="partifyLayoutDescription">'+r.html.description+"</div>";n+="             </div>"});n+="                 </div>";n+="		</div>";n+="	    </div>";n+="</div>";e("#partifyWindowContent").html(n);e(document).off("click",".partifyLayout");e(document).on("click",".partifyLayout",function(){c=o.layouts[e(this).attr("layoutId")];ct()})}else if(t.length==1){n+='<div id="partifyLayoutsCell">';n+='	    <div id="partifyLayoutsBox">';n+='             <div class="partifyLoadingBox">';n+='                 <img src="'+o.html.window.content.loadingImgPath+'" class="partifyLoadingImg"/>';n+="             </div>";n+='             <div id="partifyLayoutChoice">';n+="             </div>";n+="         </div>";n+="</div>";e("#partifyWindowContent").html(n);c=o.layouts[t[0]];ct()}else{A('The "'+u.id+'" device has no associated visibile layouts');return false}}function q(t){return e.trim(t)+"."+a}function R(t,n,r){var s=r.match(/\((.*?)\)/g);var u=[];var a=e.trim(r);var f={};if(s){u=e.trim(r.match(/\((.*?)\)/g)[0]);u=u.slice(1,-1);a=e.trim(r.replace("("+u+")",""));u=e.map(u.split(","),e.trim);e.each(u,function(n,r){if(e.inArray(r,o.componentsArray)==-1){A('The affected component "'+r+'" by the outgoing event "'+a+'" of the layout "'+t+'" does not exist');return false}})}if(n!="custom"&&e.inArray(a,i[n])==-1){A('The outgoing event "'+a+'" of the layout "'+t+'" does not exist in the default "'+n+'" events');return false}f.event=a;f.affectedComponents=u;return f}function U(){K();Z();rt();ut()}function z(){G();tt();st();ft()}function W(){e(document).off("click","#partifyWindowClose, #partifyOverlay");e(document).off("click",".partifyLayout");e(document).off("keydown","#partifyConnectVcId");e(document).off("click","#partifyConnectVcButton");e(document).off("click","#partifyVcBox .partifyWarningBackButton");e(document).off("click","#partifyConnectVcBox .partifyWarningBackButton")}function X(){Q();et();it();at()}function V(){Y();nt();ot();lt()}function J(e){l={cmd:"triggerVcEvent",vcId:p,event:e,client:{device:u,layout:{id:c.id}}};if(o.stateful){l.client.layout.components=c.componentsArray}ht(l)}function K(){var t=c.events.outgoing.keyboard;if(t){if(t=="all"){t=e.map(i.keyboard.join(" "),q)}else{t=e.map(Object.keys(c.events.outgoing.keyboardObj),q).join(" ")}e(document).on(t,function(e){if(!e.namespace||e.namespace!=a){var t={type:e.type,eventData:{timeStamp:e.timeStamp,screenDim:{height:window.screen.height,width:window.screen.width},altKey:e.altKey,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,charCode:e.charCode,keyCode:e.keyCode}};if(o.stateful){t.affectedComponents=c.events.outgoing.keyboardObj[e.type].lenght>0?c.events.outgoing.keyboardObj[e.type].join(", "):""}J(t)}})}}function Q(){var t=c.events.outgoing.keyboard;if(t){if(t=="all"){t=e.map(i.keyboard.join(" "),q)}else{t=e.map(Object.keys(c.events.outgoing.keyboardObj),q).join(" ")}e(document).off(t)}}function G(){if(c.events.incoming.keyboard){e.each(c.events.incoming.keyboard,function(t,n){e(document).on(q(t),n)})}}function Y(){if(c&&c.events&&c.events.incoming&&c.events.incoming.keyboard){e.each(c.events.incoming.keyboard,function(t,n){e(document).off(q(t))})}}function Z(){var t=c.events.outgoing.mouse;if(t){if(t=="all"){t=e.map(i.mouse.join(" "),q)}else{t=e.map(Object.keys(c.events.outgoing.mouseObj),q).join(" ")}e(document).on(t,function(e){if(!e.namespace||e.namespace!=a){var t={type:e.type,eventData:{timeStamp:e.timeStamp,screenDim:{height:window.screen.height,width:window.screen.width},altKey:e.altKey,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,button:e.button,center:{pageX:e.pageX,pageY:e.pageY},target:{id:e.target.id,classes:e.target.className.split(" ")}}};if(o.stateful){t.affectedComponents=c.events.outgoing.mouseObj[e.type].affectedComponents.length>0?c.events.outgoing.mouseObj[e.type].affectedComponents:[]}J(t)}})}}function et(){var t=c.events.outgoing.mouse;if(t){if(t=="all"){t=e.map(i.mouse.join(" "),q)}else{t=e.map(Object.keys(c.events.outgoing.mouseObj),q).join(" ")}e(document).off(t)}}function tt(){if(c.events.incoming.mouse){e.each(c.events.incoming.mouse,function(t,n){e(document).on(q(t),n)})}}function nt(){if(c&&c.events&&c.events.incoming&&c.events.incoming.mouse){e.each(c.events.incoming.mouse,function(t,n){e(document).off(q(t))})}}function rt(){var t=c.events.outgoing.touch;if(t){if(t=="all"){t=e.map(i.touch.join(" "),q)}else{t=e.map(Object.keys(c.events.outgoing.touchObj),q).join(" ")}e(document).hammer({prevent_default:true}).on(t,function(t){if(!t.namespace||t.namespace!=a){var n=[];var r={};var i={};if(t.gesture){if(t.gesture.startEvent.touches){e.each(t.gesture.startEvent.touches,function(e,t){n.push({type:t.type,eventData:{center:{pageX:t.pageX,pageY:t.pageY},parentOffsetX:t.offsetX,parentOffsetY:t.offsetY,target:{id:t.target.id,classes:t.target.className.split(" ")}}})})}i={type:t.type,eventData:{timeStamp:t.gesture.startEvent.timeStamp,target:{id:t.gesture.target.id,classes:t.gesture.target.className.split(" ")},center:t.gesture.startEvent.center,pointerType:t.gesture.startEvent.pointerType,eventType:t.gesture.startEvent.eventType,srcEventType:t.gesture.startEvent.srcEvent.type,touches:n}};if(t.gesture.touches){n=[];e.each(t.gesture.touches,function(e,t){n.push({type:t.type,eventData:{center:{pageX:t.pageX,pageY:t.pageY},parentOffsetX:t.offsetX,parentOffsetY:t.offsetY,target:{id:t.target.id,classes:t.target.className.split(" ")}}})})}r={type:t.type,eventData:{timeStamp:t.gesture.timeStamp,screenDim:{height:window.screen.height,width:window.screen.width},target:{id:t.gesture.target.id,classes:t.gesture.target.className.split(" ")},center:t.gesture.center,pointerType:t.gesture.pointerType,deltaTime:t.gesture.deltaTime,deltaX:t.gesture.deltaX,deltaY:t.gesture.deltaY,velocityX:t.gesture.velocityX,velocityY:t.gesture.velocityY,angle:t.gesture.angle,direction:t.gesture.direction,distance:t.gesture.distance,scale:t.gesture.scale,rotation:t.gesture.rotation,eventStatus:t.gesture.eventType,srcEventType:t.gesture.srcEvent.type,startEvent:i,touches:n}};if(o.stateful){r.affectedComponents=c.events.outgoing.touchObj[t.type].affectedComponents.length>0?c.events.outgoing.touchObj[t.type].affectedComponents:[]}}J(r)}})}}function it(){var t=c.events.outgoing.touch;if(t){if(t=="all"){t=e.map(i.touch.join(" "),q)}else{t=e.map(Object.keys(c.events.outgoing.touchObj),q).join(" ")}e(document).hammer().off(t)}}function st(){if(c.events.incoming.touch){e.each(c.events.incoming.touch,function(t,n){e(document).on(q(t),n)})}}function ot(){if(c&&c.events&&c.events.incoming&&c.events.incoming.touch){e.each(c.events.incoming.touch,function(t,n){e(document).off(q(t))})}}function ut(){var t=c.events.outgoing.custom;if(t){t=e.map(Object.keys(c.events.outgoing.customObj),q).join(" ");e(document).on(t,function(t){if(!t.namespace||t.namespace!=a){var n={timestamp:t.timeStamp,screenDim:{height:window.screen.height,width:window.screen.width}};var r={type:t.type,eventData:e.extend(true,{},n,t.eventData)};if(o.stateful){r.affectedComponents=c.events.outgoing.customObj[t.type].affectedComponents.length>0?c.events.outgoing.customObj[t.type].affectedComponents:[]}J(r)}})}}function at(){var t=c.events.outgoing.custom;if(t){t=e.map(Object.keys(c.events.outgoing.customObj),q).join(" ");e(document).off(t)}}function ft(){if(c.events.incoming.custom){e.each(c.events.incoming.custom,function(t,n){e(document).on(q(t),n)})}}function lt(){if(c&&c.events&&c.events.incoming&&c.events.incoming.custom){e.each(c.events.incoming.custom,function(t,n){e(document).off(q(t))})}}function ct(){if(window.WebSocket){if(e.isEmptyObject(f)){f=new WebSocket("ws://"+o.ip+":"+o.port+"/");f.onopen=pt;f.onmessage=mt;f.onerror=dt;f.onclose=vt;e("#partifyLayoutsBox .partifyLoadingBox").show();e("#partifyLayoutChoice").hide()}else{A("Waiting for WebSocket connection");return false}}else{A("The current browser does not support WebSockets");return false}}function ht(e){e=JSON.stringify(e);if(f.readyState===1){f.send(e)}else{A("WebSocket connection has been lost");return false}}function pt(e){gt();o.onWsOpen(e);c.onWsOpen(e)}function dt(t){o.onWsError(t);if(!e.isEmptyObject(c)){c.onWsError(t)}}function vt(t){if(t.code===1006){e("#partifyLayoutsBox .partifyLoadingBox").hide();e("#partifyLayoutChoice").html('<div class="partifyWarningMessage">'+o.html.window.content.warningMessages[t.code]+"</div>");e("#partifyLayoutChoice").show()}o.onWsClose(t.code,t);if(!e.isEmptyObject(c)){c.onWsClose(t.code,t)}}function mt(e){var t=JSON.parse(e.data);switch(t.cmd){case"newVc":xt(t);break;case"connVc":Tt(t);break;case"changeLayout":Nt(t);break;case"triggerVcEvent":Ct(t);break;case"rmVcClient":kt(t);break;case"rmVc":Lt(t);break;default:break}o.onWsMessage(t);c.onWsMessage(t)}function gt(){var t="";t+=yt();t+=bt();e("#partifyWindowContent").html(t);if(e("#partifyConnectVcId").length){e("#partifyConnectVcId").focus()}}function yt(){var t="";if(e.inArray("newVc",c.connectionTypesArray)>-1){wt();t+='<div id="partifyVcCell" '+(c.connectionTypesArray.length==1?'class="partifyMaxyCell"':"")+">";t+='	<div id="partifyVcBox">';t+='	    <div id="partifyVcLabel">'+o.html.window.content.vcLabel+"</div>";t+='         <div class="partifyLoadingBox">';t+='             <img src="'+o.html.window.content.loadingImgPath+'" class="partifyLoadingImg"/>';t+="         </div>";t+='	    <div id="partifyVcId"></div>';t+="	</div>";t+="</div>"}return t}function bt(){var t="";if(e.inArray("connVc",c.connectionTypesArray)>-1){t+='<div id="partifyConnectVcCell" '+(c.connectionTypesArray.length==1?'class="partifyMaxyCell"':"")+">";t+='	<div id="partifyConnectVcBox">';t+='	    <div id="partifyConnectVcLabel">'+o.html.window.content.connectVcLabel+"</div>";t+='         <div class="partifyLoadingBox">';t+='             <img src="'+o.html.window.content.loadingImgPath+'" class="partifyLoadingImg"/>';t+="         </div>";t+='	    <div id="partifyConnectVc"><input type="text" pattern="[0-9]*" id="partifyConnectVcId"/><button id="partifyConnectVcButton">'+o.html.window.content.connectVcButton+"</button></div>";t+="	</div>";t+="</div>";e(document).off("keydown","#partifyConnectVcId");e(document).on("keydown","#partifyConnectVcId",function(t){if(t.keyCode==13){e("#partifyConnectVcButton").trigger("click")}});e(document).off("click","#partifyConnectVcButton");e(document).on("click","#partifyConnectVcButton",function(){p=e("#partifyConnectVcId").val();Et()})}return t}function wt(){e("#partifyVcId").hide();e("#partifyVcBox .partifyLoadingBox").show();l={cmd:"newVc",vcId:"",client:{device:u,layout:{id:c.id}}};if(o.stateful){l.initComponents={};e.each(o.components,function(e,t){l.initComponents[e]={};l.initComponents[e].id=t.id;l.initComponents[e].state=t.state});l.client.layout.components=o.componentsArray}l.initLayouts={};e.each(o.layouts,function(e,t){l.initLayouts[e]={};l.initLayouts[e].id=t.id;l.initLayouts[e].maxInstances=t.maxInstances;l.initLayouts[e].instances=[]});ht(l)}function Et(){e("#partifyConnectVc").hide();e("#partifyConnectVcBox .partifyLoadingBox").show();l={cmd:"connVc",vcId:p,client:{device:u,layout:{id:c.id}}};if(o.stateful){l.client.layout.components=c.componentsArray}ht(l)}function St(t){if(o.layouts[t]){if(t!=c.id){if(e.inArray(u.id,o.layouts[t].devicesArray)>-1){var n=c;var r=o.layouts[t];c=r;l={cmd:"changeLayout",vcId:p,client:{device:u,layout:{id:c.id},oldLayout:{id:n.id}}};if(o.stateful){l.client.layout.components=c.componentsArray}ht(l)}else{A('The layout "'+t+'"  is not associated with the current "'+u.id+'" device');return false}}else{A('The layout "'+t+'" is the current layout');return false}}else{A('The layout "'+t+'" does not exist');return false}}function xt(t){var n={namespace:a,timeStamp:t.timeStamp,type:t.cmd,eventData:{},client:t.client,vcId:t.vcId,vcClients:t.vcClients,vcLayouts:t.vcLayouts};e("#partifyVcBox .partifyLoadingBox").hide();e("#partifyVcId").show();p=t.vcId;if(d==null&&t.client.isMe){d=t.client.id}if(t.statusCode!=b){o.onWarning(t.statusCode);c.onWarning(t.statusCode);var r="";r+='<div class="partifyWarning">';r+=' <div class="partifyWarningMessage">'+o.html.window.content.warningMessages[t.statusCode]+"</div>";r+=' <div class="partifyWarningBackButton">'+o.html.window.content.warningBackButton+"</div>";r+="</div>";e("#partifyVcId").html(r);e(document).off("click","#partifyVcBox .partifyWarningBackButton");e(document).on("click","#partifyVcBox .partifyWarningBackButton",function(){e("#partifyVcId").hide();e("#partifyVcBox .partifyLoadingBox").show();var t="";t+=yt();e("#partifyVcCell").replaceWith(t)})}else{e("#partifyVcId").html(p);c.events.incoming.partify.newVc(n,t)}}function Tt(t){var r={namespace:a,timeStamp:t.timeStamp,type:t.cmd,eventData:{},client:t.client,vcId:t.vcId,vcClients:t.vcClients,vcLayouts:t.vcLayouts};if(d==null&&t.client.isMe){d=t.client.id}if(t.statusCode!=b){if(t.lock){E=Date.now();if(!w){w=true;S=E}if(E-S>o.connVcTimeout){o.onWarning(t.statusCode);c.onWarning(t.statusCode);w=false;e("#partifyConnectVcBox .partifyLoadingBox").hide();e("#partifyConnectVc").show();var i="";i+='<div class="partifyWarning">';i+=' <div class="partifyWarningMessage">'+o.html.window.content.warningMessages[t.statusCode]+"</div>";i+=' <div class="partifyWarningBackButton">'+o.html.window.content.warningBackButton+"</div>";i+="</div>";e("#partifyConnectVc").html(i);e(document).off("click","#partifyConnectVcBox .partifyWarningBackButton");e(document).on("click","#partifyConnectVcBox .partifyWarningBackButton",function(){var t="";t+=bt();e("#partifyConnectVcCell").replaceWith(t);e("#partifyConnectVcId").focus()})}else{setTimeout(function(){Et()},o.connVcInterval)}}else{o.onWarning(t.statusCode);c.onWarning(t.statusCode);e("#partifyConnectVcBox .partifyLoadingBox").hide();e("#partifyConnectVc").show();var i="";i+='<div class="partifyWarning">';i+=' <div class="partifyWarningMessage">'+o.html.window.content.warningMessages[t.statusCode]+"</div>";i+=' <div class="partifyWarningBackButton">'+o.html.window.content.warningBackButton+"</div>";i+="</div>";e("#partifyConnectVc").html(i);e(document).off("click","#partifyConnectVcBox .partifyWarningBackButton");e(document).on("click","#partifyConnectVcBox .partifyWarningBackButton",function(){var t="";t+=bt();e("#partifyConnectVcCell").replaceWith(t);e("#partifyConnectVcId").focus()})}}else{if(!y){y=true;e("#partifyConnectVcBox .partifyLoadingBox").hide();if(o.stateful){if(t.client.isMe){Ot(t.componentsFromServer)}}n.focus();P();U();z();L();F(function(){c.events.incoming.partify.connVc(r,t);o.onMultiDeviceMode();c.onMultiDeviceMode();g=m})}else{c.events.incoming.partify.connVc(r,t)}}}function Nt(t){var n={namespace:a,timeStamp:t.timeStamp,type:t.cmd,eventData:{},client:t.client,vcId:t.vcId,vcClients:t.vcClients,vcLayouts:t.vcLayouts};if(t.statusCode!=b){o.onWarning(t.statusCode);c.onWarning(t.statusCode)}else{if(t.client.isMe){e("link[href='"+o.layouts[t.client.oldLayout.id].css+"']").remove();X();V();h={};if(o.stateful){Ot(t.componentsFromServer)}P();U();z()}c.events.incoming.partify.changeLayout(n,t)}}function Ct(e){var t={namespace:a,timeStamp:e.timeStamp,type:e.event.type,eventData:e.event.eventData,client:e.client,vcId:e.vcId};if(o.stateful){t.affectedComponents=e.event.affectedComponents}At(t);c.events.incoming.partify.triggerVcEvent(t,e)}function kt(e){var t={namespace:a,timeStamp:e.timeStamp,type:e.cmd,eventData:{},client:e.client,vcId:e.vcId};c.events.incoming.partify.rmVcClient(t,e)}function Lt(e){var t={namespace:a,timeStamp:e.timeStamp,type:e.cmd,eventData:{},client:e.client,vcId:e.vcId};c.events.incoming.partify.rmVc(t,e)}function At(t){e(document).trigger(t)}function Ot(t){if(t){e.each(t,function(t,n){o.components[t].state=e.extend(true,o.components[t].state,n.state)})}}function Mt(e,t){if(o.components[e]){o.components[e].state=t;if(p!=null){_t(e)}}else{A('The component "'+e+'" does not exist');return false}}function _t(e){var t={};t.id=o.components[e].id;t.state=o.components[e].state;l={cmd:"setVcCompState",vcId:p,componentState:t,client:{device:u,layout:{id:c.id,components:c.componentsArray}}};ht(l)}function Dt(e){if(o.components[e]){return o.components[e].state}else{A('The component "'+e+'" does not exist');return false}}function Pt(){return d}function Ht(){return p}function Bt(){return u}function jt(){return c}function Ft(){return g}var n=e(this);var r="#"+n.attr("id");var i={partify:["newVc","connVc","changeLayout","triggerVcEvent","rmVcClient","rmVc"],keyboard:["keydown","keypress","keyup"],mouse:["click","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup"],touch:["hold","tap","doubletap","drag","dragstart","dragend","dragup","dragdown","dragleft","dragright","swipe","swipeup","swipedown","swipeleft","swiperight","transform","transformstart","transformend","rotate","pinch","pinchin","pinchout","touch","release"],custom:[]};var s={ip:"",port:"",debug:false,stateful:false,connVcInterval:500,connVcTimeout:1e4,onInit:function(){},onDestroy:function(){},onWindowShow:function(){},onWindowHide:function(){},onMultiDeviceMode:function(){},onMonoDeviceMode:function(){},onWarning:function(e){},onWsOpen:function(e){},onWsMessage:function(e){},onWsError:function(e){},onWsClose:function(e,t){},html:{connectButton:"Connect device",disconnectButton:"Disconnect device",window:{header:{title:"Connect device",close:"Close"},content:{layoutsLabel:"Select layout",vcLabel:"Your ID",loadingImgPath:"../../src/img/loading.gif",connectVcLabel:"Connect to another ID",connectVcButton:"Connect",warningBackButton:"Try again",warningMessages:{1006:"Server connection failed<br/>Please try again later<br/>(check: server activity, server ip, server port, firewall outbound rules, client origin)",7e3:"The virtual channel does not exist",7001:"You are allready conncetd to this virtual channel<br/>Try again",7002:"There is no available virtual channel<br/>Please try again later",7003:"The virtual channel is full<br/>Please try again later",7004:"The virtual channel for current IP is full<br/>Please try again later",7005:"The virtual channel is currently busy<br/>Please try again later",7006:"The virtual channel for current layout is full<br/>Please try again later"}}}},devices:{smartphone:{minWidth:320,maxWidth:568},tablet:{minWidth:569,maxWidth:1024},desktop:{minWidth:1025,maxWidth:4096}},components:{},layouts:{}};var o=e.extend(true,{},s,t);var u={};var a="partify";var o,f,l,u,c,h,p,d,v,m,g,y,b,a,w,E,S;x();var It={};It={triggerVcEvent:At,changeLayout:St,destroy:N,getMyId:Pt,getMyVc:Ht,getMyDevice:Bt,getMyLayout:jt,getMyAppMode:Ft};if(o.stateful){It.setVcCompState=Mt;It.getVcCompState=Dt}return It}})(jQuery)

